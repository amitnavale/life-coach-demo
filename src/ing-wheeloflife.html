<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<script src="underscore-min.js"></script>
<script src="d3.v3.min.js"></script>
<script src="d3.tip.v0.6.3.js"></script>
<script src="draw.js"></script>



<dom-module id="ing-wheel-of-life">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
         @apply(--layout-horizontal);
      }
       paper-slider.blue {
        --paper-slider-knob-color: var(--paper-light-blue-500);
        --paper-slider-active-color: var(--paper-light-blue-500);
      }
      .button-width{
        width: 100px;
      }
    </style>

    <div class="container">
      <span class="header"> Wheel of life</span>
      <div id="wheelContainer">
      </div>
      <div>
        <span>{{currentSegmentLabel}}:</span>
        <paper-slider id="slider" class="blue" editable min="0" max="10" step="1" value="{{currentSegmentProgressValue}}"></paper-slider>
      </div>
      <div>
        <paper-button  raised class="login-button button-width"> <a href="/wheelpretext" class="link">Prev</a></paper-button>
        <paper-button  raised class="login-button button-width"> <a href="/smart-goals" class="link">Next</a></paper-button>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'ing-wheel-of-life',
      properties: {
        lifepreference: {
          type: Object,
          value: undefined
        },
        currentSegmentId: {
          type: String,
          value: 'HL'
        },
        currentSegmentProgressValue: {
          type: Number,
          value: 50
        },
        currentSegmentLabel: {
          type: String,
          computed: 'getCurrentSegmentLabel(currentSegmentId,lifepreference)'
        }
      },
      observers: [
        '_currentSegmentProgressValueChanged(currentSegmentProgressValue)'
      ],
      getCurrentSegmentLabel: function(currentSegmentId,lifepreference){
        if(currentSegmentId && lifepreference) {
          var selectedSegment = _.filter(lifepreference, function(item){
            return item.id === currentSegmentId;
          });
          if(selectedSegment && selectedSegment.length) {
            //this._currentSegmentProgressValueChanged(lifepreference[selectedSegment[0].order].score);
            this.$.slider.value = this.lifepreference[selectedSegment[0].order].score;
            return this.lifepreference[selectedSegment[0].order].label;
          }
          return '';
        }
      },
      ready: function() {
        this.updateSelectedSegment('HL');
        this.createChart(this.$.wheelContainer, this.lifepreference, this.updateSelectedSegment);
      },
      _currentSegmentProgressValueChanged: function(val) {
        var currentSegmentId = this.currentSegmentId;
        var selectedSegment = _.filter(this.lifepreference, function(item){
          return item.id === currentSegmentId;//window.localStorage.getItem('SelectedCatagory');
        });
        if(selectedSegment && selectedSegment.length > 0) {
          this.lifepreference[selectedSegment[0].order].score = val;
          this.createChart(this.$.wheelContainer, this.lifepreference, this.updateSelectedSegment);
        }
      },
      updateSelectedSegment: function(segmentId, context) {
        //var caller = context || this;
        this.currentSegmentId = segmentId;
        //this.currentSegmentLabel = caller.getCurrentSegmentLabel(this.currentSegmentId, this.lifepreference);
      },
      createChart: function (element, input, callbackFn) {
        var centroidfn = this.centroid;
        var context = this;
        var callMe = this.updateSelectedSegment;
        if(element){
            element.innerHTML = '';
            var margin = {top: 40, right: 10, bottom: 10, left: 10};

            var width = 300,
                height = 350,
                radius = (Math.min(width, height) / 2),
                innerRadius = 0;

            var pie = d3.layout.pie()
                .sort(null)
                .value(function(d) { return d.width; });

            var tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([0, 0])
                .html(function(d) {
                return d.data.label + ": <span style='color:orangered'>" + d.data.score + "</span>";
                });

            var arc = d3.svg.arc()
                .innerRadius(innerRadius)
                .outerRadius(function (d) { 
                return (radius - innerRadius) * (d.data.score / 10.0) + innerRadius; 
                });

            var outlineArc = d3.svg.arc()
                    .innerRadius(innerRadius)
                    .outerRadius(radius);

            var svg = d3.select(element).append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + (width / 2 + margin.left) + "," + (height / 2 + margin.top) + ")");


            svg.call(tip);
            var data = input || [ {id:'RM', order:1, score:5, weight:0.5, color:'#AB0066', label:'Romance'},
                    {id:'HL', order:2, score:5, weight:0.5, color:'#525199', label:'Health'},
                    {id:'FN', order:3, score:5, weight:0.5, color:'#D0D93C', label:'Finance'},
                    {id:'CR', order:4, score:5, weight:0.5, color:'#60A6DA', label:'Career'},
                    {id:'PG', order:5, score:5, weight:0.5, color:'#FF6200', label:'Personal Growth'},
                    {id:'HM', order:6, score:5, weight:0.5, color:'#D0D93C', label:'Home'},
                    {id:'FF', order:7, score:5, weight:0.5, color:'#000066', label:'Family & Friends'},
                    {id:'FH', order:8, score:5, weight:0.5, color:'#FF00BF', label:'Fun & Hobbies'}];
                var event = new Event('selectionchanged');

                data.forEach(function(d) {
                  d.id     =  d.id;
                  d.order  = +d.order;
                  d.color  =  d.color;
                  d.weight = +d.weight;
                  d.score  = +d.score;
                  d.width  = +d.weight;
                  d.label  =  d.label;
                });
                
                var outerGroup = svg.selectAll(".solidArc")
                    .data(pie(data))
                    .enter()
                    .append("g")
                
                outerGroup
                    .append("path")
                    .attr("fill", function(d) { return d.data.color; })
                    .attr("class", "solidArc")
                    .attr("stroke", "gray")
                    .attr("d", arc)
                    .on('mouseover', tip.show)
                    .on('mouseout', tip.hide)
                    .on('click',function(d){
                      callMe.call(context, d.data.id);  
                    });
                    
                outerGroup
                    .append("text")
                    .attr("transform", function(d) {
                      return "translate(" + centroidfn(60, width, d.startAngle, d.endAngle) + ")";
                    })
                    .attr("text-anchor", "middle")
                    .text(function(d) { return d.data.label })
                    .on('click',function(d){
                      callMe.call(context,d.data.id); 
                    });

                var outerPath = svg.selectAll(".outlineArc")
                    .data(pie(data))
                    .enter().append("path")
                    .attr("fill", "none")
                    .attr("stroke", "gray")
                    .attr("class", "outlineArc")
                    .attr("d", outlineArc);  

            
        }
      },
      centroid: function(innerR, outerR, startAngle, endAngle){
        var r = (innerR + outerR) / 2, a = (startAngle + endAngle) / 2 - (Math.PI / 2);
        return [ Math.cos(a) * r, Math.sin(a) * r ];
      }

  });
  </script>
</dom-module>